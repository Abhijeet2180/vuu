<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Vuu - The Realtime View Server</title>
        <meta name="robots" content="noindex" />
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="getting_started/getting_started.html"><strong aria-hidden="true">1.</strong> Getting Started</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="getting_started/building_from_source.html"><strong aria-hidden="true">1.1.</strong> Building From Source</a></li><li class="chapter-item expanded "><a href="getting_started/developing.html"><strong aria-hidden="true">1.2.</strong> Developing Vuu</a></li><li class="chapter-item expanded "><a href="getting_started/adding.html"><strong aria-hidden="true">1.3.</strong> Using binaries from Maven Repo</a></li></ol></li><li class="chapter-item expanded "><a href="providers_tables_viewports/providers_tables_viewports.html"><strong aria-hidden="true">2.</strong> Core Concepts</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="providers_tables_viewports/lifecycle.html"><strong aria-hidden="true">2.1.</strong> Lifecycle</a></li><li class="chapter-item expanded "><a href="providers_tables_viewports/providers.html"><strong aria-hidden="true">2.2.</strong> Providers</a></li><li class="chapter-item expanded "><a href="providers_tables_viewports/tables.html"><strong aria-hidden="true">2.3.</strong> Tables</a></li><li class="chapter-item expanded "><a href="providers_tables_viewports/viewports.html"><strong aria-hidden="true">2.4.</strong> Viewports</a></li><li class="chapter-item expanded "><a href="providers_tables_viewports/modules.html"><strong aria-hidden="true">2.5.</strong> Modules</a></li></ol></li><li class="chapter-item expanded "><a href="trees/trees_session_tables.html"><strong aria-hidden="true">3.</strong> Trees and Session Tables</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="trees/trees.html"><strong aria-hidden="true">3.1.</strong> Trees</a></li><li class="chapter-item expanded "><a href="trees/tree_builder.html"><strong aria-hidden="true">3.2.</strong> Tree Builder</a></li></ol></li><li class="chapter-item expanded "><a href="server_internals/server_internals.html"><strong aria-hidden="true">4.</strong> Server Internals</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="server_internals/tickpath.html"><strong aria-hidden="true">4.1.</strong> The Tick Path and the Slow Path</a></li><li class="chapter-item expanded "><a href="server_internals/viewport_thread.html"><strong aria-hidden="true">4.2.</strong> ViewPort Thread(s)</a></li><li class="chapter-item expanded "><a href="server_internals/join_manager.html"><strong aria-hidden="true">4.3.</strong> Join Manager</a></li></ol></li><li class="chapter-item expanded "><a href="rpc/rpc.html"><strong aria-hidden="true">5.</strong> Remote Procedure Calls</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="rpc/scopes.html"><strong aria-hidden="true">5.1.</strong> Remote Procedure Calls</a></li><li class="chapter-item expanded "><a href="rpc/Menu_items.html"><strong aria-hidden="true">5.2.</strong> Menu Items</a></li></ol></li><li class="chapter-item expanded "><a href="wire/wire_protocol.html"><strong aria-hidden="true">6.</strong> Wire Protocol</a></li><li class="chapter-item expanded "><a href="ui/ui.html"><strong aria-hidden="true">7.</strong> The UI</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="ui/grid.html"><strong aria-hidden="true">7.1.</strong> The Grid</a></li><li class="chapter-item expanded "><a href="ui/custom_controls.html"><strong aria-hidden="true">7.2.</strong> Writing Custom Controls</a></li></ol></li><li class="chapter-item expanded "><a href="perf/performance_optimization.html"><strong aria-hidden="true">8.</strong> Performance Optimization</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="perf/indices.html"><strong aria-hidden="true">8.1.</strong> Indices</a></li><li class="chapter-item expanded "><a href="perf/query_planner.html"><strong aria-hidden="true">8.2.</strong> Query Planner</a></li></ol></li><li class="chapter-item expanded "><a href="security/security.html"><strong aria-hidden="true">9.</strong> Security</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="security/Authentication.html"><strong aria-hidden="true">9.1.</strong> Authentication</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Vuu - The Realtime View Server</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="getting-started"><a class="header" href="#getting-started">Getting Started</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="building-from-source"><a class="header" href="#building-from-source">Building From Source</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="developing-vuu"><a class="header" href="#developing-vuu">Developing Vuu</a></h1>
<p>##Developing the server</p>
<ol>
<li>Install IntelliJ Community Edition (latest version, tested with 2020.3)</li>
<li>Install SDKMan (https://sdkman.io/)</li>
<li>type&gt;<code>sdk install java 15.0.2-open</code> and then &gt;<code>sdk d java 15.0.2-open</code> to make sure you're using the correct one.</li>
<li>Clone the repo into a directory on your machine</li>
<li>Open the project as a Maven build by selecting the root pom.xml (make sure you select &quot;enable adding maven modules, auto import etc..)</li>
<li>You should get one root module vuu-parent in a project list, select this</li>
<li>When the project opens you should have 2 sub modules (vuu and toolbox) </li>
</ol>
<p>##Running the Vuu Server Simulation Module</p>
<ol>
<li>Go to the SimulMain.scala, right click and run (add these into JVM args -Xmx10G -Xms5G)</li>
<li>Go to the SwingClientMain.scala, right click and run</li>
</ol>
<p>##Developing the client</p>
<ol>
<li>install node.js version 14+ and yarn</li>
<li>In a terminal, change directory into the ./vuu-ui folder</li>
<li>yarn install</li>
<li>type&gt; <code>yarn</code></li>
<li>build the ui library packages</li>
<li>type&gt; <code>yarn build</code></li>
<li>build the sample application</li>
<li>change directory into ./vuu-ui/packages/app-vuu-example</li>
<li>type&gt; <code>yarn build</code></li>
<li>run the sample application</li>
<li>type&gt; <code>yarn start</code></li>
</ol>
<p>You should know be able to use a local browser to see the Vuu demo app. </p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="using-binaries-from-maven-repo"><a class="header" href="#using-binaries-from-maven-repo">Using binaries from Maven Repo</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="providers-tables-and-viewports"><a class="header" href="#providers-tables-and-viewports">Providers, Tables and ViewPorts</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="lifecycle"><a class="header" href="#lifecycle">Lifecycle</a></h1>
<p>Vuu has a simple server side lifecycle component built it. The lifecycle is implemented as a DAG (Directed Acyclic Graph)
which allows components to be started and stopped in a sensible order. </p>
<p>##How does the lifecycle work?</p>
<p>The user interaction with the lifecycle component is very minimal by design. THe obligation is when there is a component 
that depends on something else, it registers that dependency in the construction logic. </p>
<p>As an example if we take the  VuiStateStoreProvider</p>
<pre><code class="language-scala">class VuiStateStoreProvider(val table: DataTable, val store: VuiStateStore)(implicit clock: Clock, lifecycleContainer: LifecycleContainer) extends Provider {

  //we create a lifecycle enabled runner, which is basically a thread
  private final val runner = new LifeCycleRunner(&quot;vuiStateStoreProviderRunner&quot;, () =&gt; runOnce(), minCycleTime = 10)
  //then we tell the lifecycle that this node depends on the runner being created before we can be fully initialized. 
  lifecycleContainer(this).dependsOn(runner)
  
  override val lifecycleId: String = &quot;vuiStateStoreProvider&quot;
  // &lt;snip/&gt;
  
  def runOnce() = {
    // &lt;snip/&gt;
  }

  override def subscribe(key: String): Unit = {}
  override def doStart(): Unit = {}
  override def doStop(): Unit = {}
  override def doInitialize(): Unit = {}
  override def doDestroy(): Unit = {}
}

</code></pre>
<p>What this means is that in the graph behind we have now created a vertex (directional dependency) between the runner and the VuiStateStoreProvider. </p>
<pre><code>(Core Components)
    --&gt; VuiStateStoreProvider
                --&gt; LifeCycleRunner(&quot;vuiStateStoreProviderRunner&quot;)
</code></pre>
<p>When Vuuu starts up it evaluates components from the furthest node out back to the root node. So the lifecycle runners will be started before the VuiStateStoreProvider before the core componenets etc..</p>
<p>##What does the Vui lifecycle look like on startup?</p>
<p>TODO: CJS Dump lifecycle to console out...</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="providers"><a class="header" href="#providers">Providers</a></h1>
<p>Providers are classes which receive data from a particlar location (network, file, in-process lib) and format that data into a map which matches the shape of the table
that the provider is populating. THey have a very simple interface:</p>
<p>Included below is an example of the metrics provider.</p>
<pre><code class="language-scala">
class MetricsTableProvider (table: DataTable, tableContainer: TableContainer)(implicit clock: Clock, lifecycleContainer: LifecycleContainer,
                                                                              metrics: MetricsProvider ) extends Provider with StrictLogging {

  private val runner = new LifeCycleRunner(&quot;metricsTableProvider&quot;, () =&gt; runOnce, minCycleTime = 1_000)

  lifecycleContainer(this).dependsOn(runner)

  override def subscribe(key: String): Unit = {}

  override def doStart(): Unit = {}

  override def doStop(): Unit = {}

  override def doInitialize(): Unit = {}

  override def doDestroy(): Unit = {}

  override val lifecycleId: String = &quot;metricsTableProvider&quot;

  def runOnce(): Unit ={

    try {

      val tables = tableContainer.getTables()

      tables.foreach(tableDef =&gt; {

        val counter = metrics.counter(tableDef.table + &quot;.processUpdates.Counter&quot;);
        val size = tableContainer.getTable(tableDef.table).size()

        val meter = metrics.meter(tableDef.table + &quot;.processUpdates.Meter&quot;)

        val upMap = Map(&quot;table&quot; -&gt; (tableDef.module + &quot;-&quot; + tableDef.table), &quot;updateCount&quot; -&gt; counter.getCount, &quot;size&quot; -&gt; size, &quot;updatesPerSecond&quot; -&gt; meter.getOneMinuteRate);

        table.processUpdate(tableDef.table, RowWithData(tableDef.table, upMap), clock.now())

      })

    } catch {
      case e: Exception =&gt;
        logger.error(&quot;Error occured in metrics&quot;, e)
    }
  }
}
</code></pre>
<p>As you can see from the code the important lines are:</p>
<pre><code class="language-scala">  private val runner = new LifeCycleRunner(&quot;metricsTableProvider&quot;, () =&gt; runOnce, minCycleTime = 1_000)

  lifecycleContainer(this).dependsOn(runner)

</code></pre>
<p>This sets up a thread (in this case a lifecycle aware thread, so that it shuts down happily when the process is killed)</p>
<p>And the runOnce() method:</p>
<pre><code class="language-scala">  def runOnce(): Unit ={

    try {

      val tables = tableContainer.getTables()

      tables.foreach(tableDef =&gt; {

        //source the metric's information from the metrics api for a specific table
        val counter = metrics.counter(tableDef.table + &quot;.processUpdates.Counter&quot;);
        val size = tableContainer.getTable(tableDef.table).size()
        val meter = metrics.meter(tableDef.table + &quot;.processUpdates.Meter&quot;)
        
        //format the data into a map
        val dataMap = Map(&quot;table&quot; -&gt; (tableDef.module + &quot;-&quot; + tableDef.table), &quot;updateCount&quot; -&gt; counter.getCount, &quot;size&quot; -&gt; size, &quot;updatesPerSecond&quot; -&gt; meter.getOneMinuteRate);

        //pass the data into the table as a RowWithData object, the map embedded within
        table.processUpdate(tableDef.table, RowWithData(tableDef.table, dataMap), clock.now())

      })

    } catch {
      case e: Exception =&gt;
        logger.error(&quot;Error occured in metrics&quot;, e)
    }
  }
</code></pre>
<p>As the code comments show the runOnce() method populates the table with data. </p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="tables"><a class="header" href="#tables">Tables</a></h1>
<p>Tables are sinks of data. At the lowest form they are wrappers around concurrent maps that offer some value add in propogating updates and deletes for through the system. </p>
<p>Data tables are represented by the interface io.venuu.vuu.core.table.DataTable in the source code. </p>
<pre><code class="language-scala">trait DataTable extends KeyedObservable[RowKeyUpdate] with RowSource {

  @volatile private var provider: Provider = null

  def indexForColumn(column: Column): Option[IndexedField[_]]

  def setProvider(aProvider: Provider): Unit = provider = aProvider

  def getProvider: Provider = provider

  def asTable: DataTable = this

  def columnForName(name: String): Column = getTableDef.columnForName(name)

  def columnsForNames(names: String*): List[Column] = names.map(getTableDef.columnForName(_)).toList

  def columnsForNames(names: List[String]): List[Column] = names.map(getTableDef.columnForName(_))

  def getTableDef: TableDef

  def processUpdate(rowKey: String, rowUpdate: RowWithData, timeStamp: Long): Unit

  def processDelete(rowKey: String): Unit

  def isSelectedVal(key: String, selected: Map[String, Any]): Int = {
    if (selected.contains(key)) 1 else 0
  }

  def size(): Long = {
    primaryKeys.length
  }

  def toAscii(count: Int): String = {
    val columns = getTableDef.columns
    val keys = primaryKeys

    val selectedKeys = keys.toArray.take(count)

    val rows = selectedKeys.map(key =&gt; pullRowAsArray(key, columns.toList))

    val columnNames = columns.map(_.name)

    AsciiUtil.asAsciiTable(columnNames, rows)
  }

  def toAscii(start: Int, end: Int): String = {
    val columns = getTableDef.columns
    val keys = primaryKeys

    val selectedKeys = keys.toArray.slice(start, end)//.slice(start, end)//drop(start).take(end - start)

    val rows = selectedKeys.map(key =&gt; pullRowAsArray(key, columns.toList))

    val columnNames = columns.map(_.name)

    AsciiUtil.asAsciiTable(columnNames, rows)
  }
}

</code></pre>
<p>The important methods from this train for these purposes are:</p>
<pre><code class="language-scala">def processUpdate(...)
def processDelete(...)
</code></pre>
<p>These are the methods that you call in a provider to populate data into the underlying map. If you go back to the <a href="providers_tables_viewports/providers.html">Providers</a> example you can see it is indeed the update method being called. </p>
<p>processUpdate functions like an upsert in a SQL data (i.e. it is used for both an insert and an update)</p>
<p>#Types of Table</p>
<p>#(Simple) Table</p>
<p>Simple Tables (the default table type, defined by using the TableDef() class) are sinks for data. They are wrappers around
a concurrent map and are mechanisms to propogate update or delete events to join tables and view ports. </p>
<p>#Join Tables</p>
<p>Join tables represent the logical joining of two separate tables into a single merged table. In practice they are mappings of 
keys from one table to keys from one or more other tables. When data is realised (i.e. sent down to a user's ui via the websocket) 
the relevant rows are realized by dragging the data from the underlying simple tables. </p>
<p>#AutoSubscribe Table</p>
<p>Auto subscriber tables are simple data tables that when involved in a join will receive a special callback as part of the join process
to load data from a n external source by primary key. </p>
<p>An example of an auto subscribe table would be where we have an external source, such as market data, that we only want to subscribe to if we have any other data
like orders on particular symbols. When we join orders and prices, if the prices tables is defined as an auto subscribe table, we will make a call to the 
autosubscribe table with the product symbol on the order once each time a new order is entered. </p>
<p>#Lucene Table</p>
<p>TODO: Lucene tables are a work in progress, whach this space. </p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="viewports"><a class="header" href="#viewports">Viewports</a></h1>
<p>A Viewport is a specific clients view onto an underlying table. It has knowledge of the underlying table that a viewport is looking at. It also has knowledge of
the window of data that a client currently has displayed on her screen. It contains information on any sorts, or filters that a specific client
has requested on the data, on columns that the client has asked to display as well as information such as which rows are currently selected on the clients grid. </p>
<p>As well as this viewports contain references to immutable arrays of the keys of the underlying table. These arrays are sorted and filtered based on the clients 
requested sort of the data. </p>
<p>When a user opens a viewport on a table from the client, a thread in the server will asynchronously populate the keys based on the viewports parameters into an immutable array
and will pass that array to the viewport. This thread will then continuously recalculate the keys (if there have been any changes) during the lifetime of the viewport</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="modules"><a class="header" href="#modules">Modules</a></h1>
<p>Modules are how you describe the tables, providers and rpc calls that you want to add to Vuu. THey are intended to be logical groupings of functionality that can be shared. </p>
<p>##How to define a module</p>
<p>THe best place to start with defining a module is to look at the existing ones provided in the core infra. </p>
<p>##An example module definitin:</p>
<pre><code class="language-scala">object VuiStateModule extends DefaultModule {

  final val NAME = &quot;vui&quot;

  def apply(store: VuiStateStore)(implicit clock: Clock, lifecycle: LifecycleContainer): ViewServerModule = {

    ModuleFactory.withNamespace(NAME)
      .addTable(
        TableDef(
          name = &quot;uiState&quot;,
          keyField = &quot;uniqueId&quot;,
          columns = Columns.fromNames(&quot;uniqueId&quot;.string(), &quot;user&quot;.string(), &quot;id&quot;.string(), &quot;lastUpdate&quot;.long()),
          VisualLinks(),
        ),
        (table, vs) =&gt; new VuiStateStoreProvider(table, store)
      )
      .addRestService(_ =&gt; new VuiStateRestService(store))
      .asModule()
  }
}
</code></pre>
<p>Above is the module which provides storage and retrieval of UI state across sessions. As you can see there are a few key things that you need to provide when adding a module. </p>
<ol>
<li>Name - This is a unique name in the deployment</li>
<li>An apply function that defines zero or more tables, providers, rest services, rpc services etc..</li>
</ol>
<p>In this example we define 1 table, &quot;uiState&quot;, with the primary key &quot;uniqueId.&quot; we also have three additional fields &quot;user&quot;, &quot;id&quot; and &quot;lastUpdate&quot;. </p>
<p>The provider as discussed in a previous section, is responsible from sourcing data from somewhere and inserting the data or removing the data from the data table. </p>
<p>If you look at the source code for the provider you can see that it uses a utility class VuiStateStore to retrieve the versions of the UI that have been saved. It also stores a magic
head state which is the current live state. </p>
<pre><code class="language-scala">class VuiStateStoreProvider(val table: DataTable, val store: VuiStateStore)(implicit clock: Clock, lifecycleContainer: LifecycleContainer) extends Provider {

  private final val runner = new LifeCycleRunner(&quot;vuiStateStoreProviderRunner&quot;, () =&gt; runOnce(), minCycleTime = 10)
  override val lifecycleId: String = &quot;vuiStateStoreProvider&quot;
  @volatile
  private var lastState = List[VuiHeader]()

  def runOnce() = {

    val states = store.getAll()

    for(state &lt;- states){

      table.processUpdate(state.uniqueId, RowWithData( state.uniqueId, Map(&quot;uniqueId&quot; -&gt;  state.uniqueId,
        &quot;user&quot; -&gt; state.user,
        &quot;id&quot; -&gt; state.id,
        &quot;lastUpdate&quot; -&gt; state.lastUpdate )
      ),
        clock.now()
      )
    }

    for(oldState &lt;- lastState){
      if(!states.contains(oldState)){
        table.processDelete(oldState.uniqueId)
      }
    }
v
    lastState = states
  }

  override def subscribe(key: String): Unit = {}
  override def doStart(): Unit = {}
  override def doStop(): Unit = {}
  override def doInitialize(): Unit = {}
  override def doDestroy(): Unit = {}
}
</code></pre>
<p>In the module we also define a rest service. This is how the UI interacts with the state store. THe rest service is exposed via the underlying Vert.x
infrastructure. </p>
<pre><code class="language-scala">class VuiStateRestService(val store: VuiStateStore)(implicit clock: Clock) extends RestService {

  private final val service = &quot;vui&quot;

  override def getServiceName: String = service
  override def getUriGetAll: String = s&quot;/api/$service/:user&quot;
  override def getUriGet: String = s&quot;/api/$service/:user/:id&quot;
  override def getUriPost: String = s&quot;/api/$service/:user&quot;
  override def getUriDelete: String = s&quot;/api/$service/:user/:id&quot;
  override def getUriPut: String = s&quot;/api/$service/:user/:id&quot;

  override def onGetAll(ctx: RoutingContext): Unit = {
    val user = ctx.request().getParam(&quot;user&quot;)
    if(user == null){
      reply404(ctx)
    }else{
      val states = store.getAllFor(user)
      val json = JsonUtil.toPrettyJson(states)
      ctx.response()
        .putHeader(&quot;content-type&quot;, &quot;application/json; charset=utf-8&quot;)
        .end(json)
    }
  }

  override def onPost(ctx: RoutingContext): Unit = {
    val user = ctx.request().getParam(&quot;user&quot;)
    val id   = &quot;latest&quot;
    val json = ctx.getBodyAsString()

    if(user == null || id == null || json == null){
      reply404(ctx)
    }else{
      store.add(VuiState(VuiHeader(user, id, user + &quot;.&quot; + id, clock.now()), VuiJsonState(json)))
      ctx.response()
        .setStatusCode(201)
        .putHeader(&quot;content-type&quot;, &quot;application/json; charset=utf-8&quot;)
        .end(json);
    }
  }

  override def onGet(ctx: RoutingContext): Unit = {
    val user = ctx.request().getParam(&quot;user&quot;)
    val id   = ctx.request().getParam(&quot;id&quot;)
    if(user == null || id == null){
      ctx.response().setStatusCode(404).end()
    }else{
      store.get(user, id) match {
        case Some(state) =&gt;
          ctx.response()
            .putHeader(&quot;content-type&quot;, &quot;application/json; charset=utf-8&quot;)
            .end(state.json.json);
        case None =&gt;
          reply404(ctx)
      }
    }
  }

  override def onPut(ctx: RoutingContext): Unit = {
    val user = ctx.request().getParam(&quot;user&quot;)
    val id   = ctx.request().getParam(&quot;id&quot;)
    val json = ctx.getBodyAsString()
    if(user == null || id == null || json == null){
      reply404(ctx)
    }else{
      store.add(VuiState(VuiHeader(user, id, user + &quot;.&quot; + id, clock.now()), VuiJsonState(json)))
      ctx.response()
        .setStatusCode(201)
        .putHeader(&quot;content-type&quot;, &quot;application/json; charset=utf-8&quot;)
        .end(json);
    }
  }

  override def onDelete(ctx: RoutingContext): Unit = {
    val user = ctx.request().getParam(&quot;user&quot;)
    val id   = ctx.request().getParam(&quot;id&quot;)
    if(user == null || id == null){
      reply404(ctx)
    }else{
      store.delete(user, id)
      ctx.response.setStatusCode(204).end()
    }
  }
}


</code></pre>
<p>So you can see from this example we have:</p>
<ol>
<li>A storage mechanism, the VuiStateStore</li>
<li>An update and retrieve mechanism, via the REST service. </li>
<li>A table definition, that exposes the state store to the UI via the table mechanism. In this case this is largely for auditing purposes. </li>
</ol>
<p>From here we can move onto to a ore complicated example. </p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="trees-and-session-tables"><a class="header" href="#trees-and-session-tables">Trees and Session Tables</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="trees"><a class="header" href="#trees">Trees</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="tree-builder"><a class="header" href="#tree-builder">Tree Builder</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="server-internals"><a class="header" href="#server-internals">Server Internals</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="the-tick-path"><a class="header" href="#the-tick-path">The Tick Path</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="viewport-threads"><a class="header" href="#viewport-threads">ViewPort Thread(s)</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="join-manager"><a class="header" href="#join-manager">Join Manager</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="remote-procedure-calls"><a class="header" href="#remote-procedure-calls">Remote Procedure Calls</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="remote-procedure-calls-1"><a class="header" href="#remote-procedure-calls-1">Remote Procedure Calls</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="menu-items"><a class="header" href="#menu-items">Menu Items</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="wire-protocol"><a class="header" href="#wire-protocol">Wire Protocol</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="the-ui"><a class="header" href="#the-ui">The UI</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="the-grid"><a class="header" href="#the-grid">The Grid</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="writing-custom-controls"><a class="header" href="#writing-custom-controls">Writing Custom Controls</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="performance-optimization"><a class="header" href="#performance-optimization">Performance Optimization</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="indices"><a class="header" href="#indices">Indices</a></h1>
<p>Indices are a mechansim for filter a tables keys quickly. They are defined as part of a table  and under the hood they are implemented as skip lists. 
Currently there is no query planner for indices, as a more advanced SQL data base might have. THey simply will short cut the filter process if an index exists on a field. </p>
<p>Adding indices to a field dramatically reduces the cost of filter on that field, at the slight processing expense and memory expense of maintaining an extra data structure.</p>
<p>Below is a table that has an index defined on the ric field. </p>
<pre><code class="language-scala">
    TableDef(
          name = &quot;parentOrders&quot;,
          keyField = &quot;id&quot;,
          Columns.fromNames(&quot;id:String&quot;, &quot;idAsInt: Int&quot;, &quot;ric:String&quot;, &quot;childCount: Int&quot;, &quot;price:Double&quot;, &quot;quantity:Int&quot;, &quot;side:String&quot;, &quot;account:String&quot;, &quot;exchange: String&quot;,
                                    &quot;ccy: String&quot;, &quot;algo: String&quot;, &quot;volLimit:Double&quot;, &quot;filledQty:Int&quot;, &quot;openQty:Int&quot;, &quot;averagePrice: Double&quot;, &quot;status:String&quot;,
                                    &quot;lastUpdate:Long&quot;),
          VisualLinks(
            Link(&quot;ric&quot;, &quot;prices&quot;, &quot;ric&quot;)
          ),
          //index
          indices = Indices(
            Index(&quot;ric&quot;)
          ),
          joinFields = &quot;id&quot;, &quot;ric&quot;
        ),
        (table, vs) =&gt; new ParentOrdersProvider(table, ordersModel)
      )


</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="query-planner"><a class="header" href="#query-planner">Query Planner</a></h1>
<p>THe query planner is a work in progress, watch here for more details:</p>
<ul>
<li><input disabled="" type="checkbox"/>
https://github.com/octo-org/octo-repo/issues/740</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="security"><a class="header" href="#security">Security</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="authentication"><a class="header" href="#authentication">Authentication</a></h1>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        <script type="text/javascript">
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>
    </body>
</html>
